name: Generate Video Clips

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Generate Sentence Voiceovers"]
    types:
      - completed

permissions:
  contents: write

jobs:
  create-clips:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install FFmpeg
        run: sudo apt-get update && sudo apt-get install -y ffmpeg

      - name: Generate High Quality MP4 Clips
        shell: bash
        run: |
          python3 <<'EOF'
          import json
          import os
          import subprocess
          import sys

          VISUALS_PATH = 'Visuals/visuals.json'
          AUDIO_DIR = 'Audio'
          IMAGE_DIR = 'Images'
          CLIPS_DIR = 'Clips'

          os.makedirs(CLIPS_DIR, exist_ok=True)

          def validate_output(path):
              try:
                  r = subprocess.run(
                      ['ffprobe','-v','error',
                       '-show_entries','format=duration',
                       '-of','default=noprint_wrappers=1:nokey=1',
                       path],
                      capture_output=True,text=True
                  )
                  return r.returncode == 0 and float(r.stdout.strip()) > 0
              except:
                  return False

          def create_clip(num):
              audio = os.path.join(AUDIO_DIR, f"a{num}.mp3")
              image = os.path.join(IMAGE_DIR, f"i{num}.png")
              output = os.path.join(CLIPS_DIR, f"c{num}.mp4")

              if not os.path.exists(audio) or not os.path.exists(image):
                  print(f"‚ùå Missing media for {num}")
                  return False

              cmd = [
                  'ffmpeg','-y',
                  '-loop','1',
                  '-i',image,
                  '-i',audio,
                  '-vf','scale=1920:1080:force_original_aspect_ratio=decrease,pad=1920:1080:(ow-iw)/2:(oh-ih)/2',
                  '-c:v','libx264',
                  '-preset','slow',
                  '-crf','20',
                  '-pix_fmt','yuv420p',
                  '-c:a','aac',
                  '-b:a','192k',
                  '-ar','44100',
                  '-movflags','+faststart',
                  '-shortest',
                  output
              ]

              try:
                  subprocess.check_call(cmd)
              except:
                  return False

              return validate_output(output)

          if not os.path.exists(VISUALS_PATH):
              print("‚ùå visuals.json missing")
              sys.exit(1)

          data = json.load(open(VISUALS_PATH))
          success = 0

          for item in data:
              num = item.get("number")
              if num and create_clip(num):
                  success += 1

          if success == 0:
              sys.exit(1)

          print(f"üé¨ Created {success} clips")
          EOF

      - name: Commit and Push Clips
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          git config --global user.name "cowboycode9"
          git config --global user.email "cowboycode9@outlook.com"

          if [ -n "$GH_PAT" ]; then
            git remote set-url origin "https://x-access-token:${GH_PAT}@github.com/${{ github.repository }}.git"
          fi

          git add Clips/*.mp4 || true

          if git diff --staged --quiet; then
            echo "No new clips."
          else
            timestamp=$(TZ="Asia/Kolkata" date +"%Y-%m-%d %H:%M:%S IST")
            git commit -m "üé¨ Video Clips Update: ${timestamp}"
            git push origin main
          fi
