name: Final Video Assembly

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Generate Video Clips"]
    types:
      - completed

permissions:
  contents: write

jobs:
  merge-final-video:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install FFmpeg
        run: sudo apt-get update && sudo apt-get install -y ffmpeg

      - name: Merge Clips into Final Video
        shell: bash
        run: |
          python3 - <<EOF
          import json
          import os
          import subprocess

          VISUALS_PATH = 'Visuals/visuals.json'
          CLIPS_DIR = os.path.abspath('Clips')
          VIDEO_DIR = os.path.abspath('Video')
          CONCAT_FILE = 'clips_to_merge.txt'
          OUTPUT_VIDEO = os.path.join(VIDEO_DIR, 'final_video.mp4')

          def main():
              if not os.path.exists(VISUALS_PATH):
                  print("Visuals file not found.")
                  return
              
              os.makedirs(VIDEO_DIR, exist_ok=True)

              with open(VISUALS_PATH, 'r') as f:
                  data = json.load(f)

              clips = []
              for item in data:
                  num = item.get('number')
                  clip_path = os.path.join(CLIPS_DIR, f"c{num}.mp4")
                  
                  if os.path.exists(clip_path) and os.path.getsize(clip_path) > 0:
                      path_for_ffmpeg = clip_path.replace("'", "'\\''")
                      clips.append(f"file '{path_for_ffmpeg}'")
                  else:
                      print(f"Warning: Clip {num} is missing or empty.")

              if not clips:
                  print("No valid clips found to merge.")
                  return

              with open(CONCAT_FILE, 'w') as f:
                  f.write('\n'.join(clips))

              cmd = [
                  'ffmpeg', '-y',
                  '-f', 'concat',
                  '-safe', '0',
                  '-i', CONCAT_FILE,
                  '-c:v', 'libx264',
                  '-pix_fmt', 'yuv420p',
                  '-c:a', 'aac',
                  '-shortest',
                  OUTPUT_VIDEO
              ]
              
              result = subprocess.run(cmd, capture_output=True, text=True)
              
              if result.returncode != 0:
                  print(result.stderr)
                  exit(1)
                  
              print(f"Final Video Created: {OUTPUT_VIDEO}")
              
              if os.path.exists(CONCAT_FILE):
                  os.remove(CONCAT_FILE)

          if __name__ == "__main__":
              main()
          EOF

      - name: Commit and Push Final Video
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          git config --global user.name "cowboycode9"
          git config --global user.email "cowboycode9@outlook.com"
          
          if [ -n "$GH_PAT" ]; then
            git remote set-url origin "https://x-access-token:${GH_PAT}@github.com/${{ github.repository }}.git"
          fi

          git add Video/final_video.mp4
          
          if git diff --staged --quiet; then
            echo "No changes."
          else
            timestamp=$(TZ="Asia/Kolkata" date +"%Y-%m-%d %H:%M:%S IST")
            git commit -m "ðŸš€ Final Video Rendered: ${timestamp}"
            git pull origin main --rebase
            git push origin main
          fi
