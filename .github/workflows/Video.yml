name: Final Video Assembly

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Generate Video Clips"]
    types:
      - completed

permissions:
  contents: write

jobs:
  merge-final-video:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install FFmpeg
        run: sudo apt-get update && sudo apt-get install -y ffmpeg

      - name: Merge Clips into Final Video
        shell: bash
        run: |
          python3 - <<'EOF'
          import json
          import os
          import subprocess
          import sys

          # --- CONFIGURATION ---
          VISUALS_PATH = 'Visuals/visuals.json'
          CLIPS_DIR = 'Clips'
          VIDEO_DIR = 'Video'
          CONCAT_FILE = 'clips_to_merge.txt'
          OUTPUT_VIDEO = os.path.join(VIDEO_DIR, 'final_video.mp4')

          def validate_video(filepath):
              """Check if video file is valid and playable"""
              try:
                  result = subprocess.run(
                      ['ffprobe', '-v', 'error', '-select_streams', 'v:0',
                       '-show_entries', 'stream=codec_name,width,height:format=duration',
                       '-of', 'json', filepath],
                      capture_output=True,
                      text=True,
                      timeout=10
                  )
                  if result.returncode != 0:
                      return False, "FFprobe failed"
                  
                  data = json.loads(result.stdout)
                  if 'streams' not in data or not data['streams']:
                      return False, "No video stream"
                  
                  if 'format' not in data or 'duration' not in data['format']:
                      return False, "No duration info"
                  
                  duration = float(data['format']['duration'])
                  if duration <= 0:
                      return False, f"Invalid duration: {duration}"
                  
                  stream = data['streams'][0]
                  info = f"{stream.get('width', '?')}x{stream.get('height', '?')}, {duration:.2f}s"
                  return True, info
                  
              except json.JSONDecodeError:
                  return False, "Invalid ffprobe output"
              except Exception as e:
                  return False, str(e)

          def get_video_specs(filepath):
              """Get detailed video specifications"""
              try:
                  result = subprocess.run(
                      ['ffprobe', '-v', 'error', '-select_streams', 'v:0',
                       '-show_entries', 'stream=codec_name,width,height,r_frame_rate,pix_fmt',
                       '-of', 'json', filepath],
                      capture_output=True,
                      text=True,
                      timeout=10
                  )
                  if result.returncode == 0:
                      data = json.loads(result.stdout)
                      if data.get('streams'):
                          return data['streams'][0]
              except:
                  pass
              return None

          def main():
              print("="*70)
              print("ðŸŽ¬ FINAL VIDEO ASSEMBLY")
              print("="*70)
              
              if not os.path.exists(VISUALS_PATH):
                  print("âŒ ERROR: Visuals file not found.")
                  sys.exit(1)
              
              os.makedirs(VIDEO_DIR, exist_ok=True)

              with open(VISUALS_PATH, 'r') as f:
                  data = json.load(f)

              print(f"\nðŸ“‹ Expected clips based on visuals.json: {len(data)}")

              # Collect and validate clips
              valid_clips = []
              missing_clips = []
              invalid_clips = []
              total_duration = 0.0

              print("\nðŸ” Validating clips...\n")

              for item in data:
                  num = item.get('number')
                  clip_path = os.path.join(CLIPS_DIR, f"c{num}.mp4")
                  
                  if not os.path.exists(clip_path):
                      missing_clips.append(f"c{num}.mp4")
                      print(f"  âŒ c{num}.mp4 - NOT FOUND")
                      continue
                  
                  # Check file size
                  size = os.path.getsize(clip_path)
                  if size < 1024:  # Less than 1KB
                      invalid_clips.append(f"c{num}.mp4 (only {size} bytes)")
                      print(f"  âŒ c{num}.mp4 - TOO SMALL ({size} bytes)")
                      continue
                  
                  # Validate video integrity
                  is_valid, info = validate_video(clip_path)
                  if not is_valid:
                      invalid_clips.append(f"c{num}.mp4 ({info})")
                      print(f"  âŒ c{num}.mp4 - INVALID ({info})")
                      continue
                  
                  # Extract duration for total calculation
                  try:
                      dur_result = subprocess.run(
                          ['ffprobe', '-v', 'error', '-show_entries',
                           'format=duration', '-of', 'default=noprint_wrappers=1:nokey=1',
                           clip_path],
                          capture_output=True, text=True, timeout=5
                      )
                      if dur_result.returncode == 0:
                          total_duration += float(dur_result.stdout.strip())
                  except:
                      pass
                  
                  valid_clips.append(clip_path)
                  print(f"  âœ… c{num}.mp4 - {info} ({size:,} bytes)")

              # Report summary
              print("\n" + "="*70)
              print("ðŸ“Š VALIDATION SUMMARY")
              print("="*70)
              print(f"  âœ… Valid clips:   {len(valid_clips)}")
              print(f"  âŒ Missing clips: {len(missing_clips)}")
              print(f"  âŒ Invalid clips: {len(invalid_clips)}")
              print(f"  â±ï¸  Total duration: {total_duration:.2f}s ({total_duration/60:.2f} min)")
              
              if missing_clips:
                  print(f"\nâŒ Missing clips:")
                  for clip in missing_clips[:10]:  # Show first 10
                      print(f"     - {clip}")
                  if len(missing_clips) > 10:
                      print(f"     ... and {len(missing_clips)-10} more")
              
              if invalid_clips:
                  print(f"\nâŒ Invalid clips:")
                  for clip in invalid_clips[:10]:
                      print(f"     - {clip}")
                  if len(invalid_clips) > 10:
                      print(f"     ... and {len(invalid_clips)-10} more")

              if not valid_clips:
                  print("\nâŒ FATAL ERROR: No valid clips found to merge!")
                  sys.exit(1)

              print("\n" + "="*70)
              print(f"ðŸŽ¬ Proceeding with {len(valid_clips)} valid clips")
              print("="*70)

              # Check consistency of video specs
              first_spec = get_video_specs(valid_clips[0])
              if first_spec:
                  print(f"\nðŸ“ Reference specs (from first clip):")
                  print(f"     Codec: {first_spec.get('codec_name', 'unknown')}")
                  print(f"     Resolution: {first_spec.get('width', '?')}x{first_spec.get('height', '?')}")
                  print(f"     Pixel Format: {first_spec.get('pix_fmt', 'unknown')}")

              # Write concat file
              with open(CONCAT_FILE, 'w') as f:
                  for clip_path in valid_clips:
                      # Use relative paths for portability
                      f.write(f"file '{clip_path}'\n")

              print(f"\nðŸ“ Created concat file: {CONCAT_FILE}")

              # Method 1: Try concat demuxer (fastest, no re-encode)
              print("\nðŸš€ Attempting fast merge (concat demuxer - no re-encoding)...")
              
              cmd_concat = [
                  'ffmpeg', '-y',
                  '-f', 'concat',
                  '-safe', '0',
                  '-i', CONCAT_FILE,
                  '-c', 'copy',
                  '-movflags', '+faststart',
                  OUTPUT_VIDEO
              ]
              
              result = subprocess.run(cmd_concat, capture_output=True, text=True)
              
              if result.returncode == 0 and os.path.exists(OUTPUT_VIDEO):
                  size = os.path.getsize(OUTPUT_VIDEO)
                  print(f"\nâœ… SUCCESS! Final video created using concat demuxer")
                  print(f"   ðŸ“ Output: {OUTPUT_VIDEO}")
                  print(f"   ðŸ’¾ Size: {size:,} bytes ({size/1024/1024:.2f} MB)")
                  
                  # Validate final output
                  is_valid, info = validate_video(OUTPUT_VIDEO)
                  if is_valid:
                      print(f"   âœ… Validation: {info}")
                  else:
                      print(f"   âš ï¸  Warning: {info}")
                  
                  if os.path.exists(CONCAT_FILE):
                      os.remove(CONCAT_FILE)
                  return
              
              # Method 2: Fallback to concat filter (re-encodes)
              print("\nâš ï¸  Concat demuxer failed, trying concat filter (with re-encoding)...")
              print(f"   Error was: {result.stderr[:200]}")
              
              filter_inputs = []
              for clip in valid_clips:
                  filter_inputs.extend(['-i', clip])
              
              n = len(valid_clips)
              filter_complex = f"concat=n={n}:v=1:a=1[outv][outa]"
              
              cmd_filter = [
                  'ffmpeg', '-y'
              ] + filter_inputs + [
                  '-filter_complex', filter_complex,
                  '-map', '[outv]',
                  '-map', '[outa]',
                  '-c:v', 'libx264',
                  '-preset', 'medium',
                  '-crf', '23',
                  '-c:a', 'aac',
                  '-b:a', '192k',
                  '-movflags', '+faststart',
                  OUTPUT_VIDEO
              ]
              
              print(f"\nðŸ”„ Re-encoding {n} clips...")
              result2 = subprocess.run(cmd_filter, capture_output=True, text=True)
              
              if result2.returncode != 0:
                  print(f"\nâŒ FATAL ERROR: Both merge methods failed!")
                  print(f"\nConcat demuxer error:\n{result.stderr[:500]}")
                  print(f"\nConcat filter error:\n{result2.stderr[:500]}")
                  sys.exit(1)
              
              if os.path.exists(OUTPUT_VIDEO):
                  size = os.path.getsize(OUTPUT_VIDEO)
                  print(f"\nâœ… SUCCESS! Final video created using concat filter")
                  print(f"   ðŸ“ Output: {OUTPUT_VIDEO}")
                  print(f"   ðŸ’¾ Size: {size:,} bytes ({size/1024/1024:.2f} MB)")
                  
                  is_valid, info = validate_video(OUTPUT_VIDEO)
                  if is_valid:
                      print(f"   âœ… Validation: {info}")
                  else:
                      print(f"   âš ï¸  Warning: {info}")
              else:
                  print("\nâŒ ERROR: Output file was not created!")
                  sys.exit(1)
              
              # Cleanup
              if os.path.exists(CONCAT_FILE):
                  os.remove(CONCAT_FILE)
              
              print("\n" + "="*70)
              print("ðŸŽ‰ FINAL VIDEO ASSEMBLY COMPLETE!")
              print("="*70)

          if __name__ == "__main__":
              main()
          EOF

      - name: Setup Git LFS for Large Video
        run: |
          # Check if final video is larger than 50MB
          if [ -f "Video/final_video.mp4" ]; then
            size=$(stat -f%z "Video/final_video.mp4" 2>/dev/null || stat -c%s "Video/final_video.mp4" 2>/dev/null || echo "0")
            if [ "$size" -gt 52428800 ]; then
              echo "ðŸ“¦ Final video is large ($(($size/1024/1024))MB), setting up Git LFS..."
              git lfs install
              git lfs track "*.mp4"
              git add .gitattributes
            else
              echo "âœ… Final video size OK ($(($size/1024/1024))MB)"
            fi
          fi

      - name: Commit and Push Final Video
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          git config --global user.name "intellectra9"
          git config --global user.email "intellectra9@outlook.com"
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          
          if [ -n "$GH_PAT" ]; then
            git remote set-url origin "https://x-access-token:${GH_PAT}@github.com/${{ github.repository }}.git"
          fi

          # Add files
          git add Video/final_video.mp4 2>/dev/null || echo "No final video to add"
          git add .gitattributes 2>/dev/null || echo "No .gitattributes changes"
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸  No changes to commit."
          else
            timestamp=$(TZ="Asia/Kolkata" date +"%Y-%m-%d %H:%M:%S IST")
            
            # Get video info for commit message
            if [ -f "Video/final_video.mp4" ]; then
              size=$(stat -f%z "Video/final_video.mp4" 2>/dev/null || stat -c%s "Video/final_video.mp4" 2>/dev/null || echo "0")
              size_mb=$(($size/1024/1024))
              
              duration=$(ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 "Video/final_video.mp4" 2>/dev/null || echo "0")
              duration_formatted=$(printf "%.1f" "$duration")
              
              git commit -m "ðŸŽ¥ Final Video Assembly Complete: ${timestamp}

ðŸ“Š Video Stats:
   ðŸ’¾ Size: ${size_mb}MB
   â±ï¸  Duration: ${duration_formatted}s
   ðŸŽ¬ Status: Ready for distribution"
            else
              git commit -m "ðŸŽ¥ Final Video Update: ${timestamp}"
            fi
            
            # Pull and push with retry
            max_retries=3
            retry_count=0
            
            while [ $retry_count -lt $max_retries ]; do
              git pull origin main --rebase || git pull origin main --strategy-option=ours
              
              if git push origin main; then
                echo "âœ… Successfully pushed final video!"
                exit 0
              else
                retry_count=$((retry_count + 1))
                echo "âš ï¸  Push failed, retrying ($retry_count/$max_retries)..."
                sleep 5
              fi
            done
            
            echo "âŒ Failed to push after $max_retries attempts"
            exit 1
          fi

      - name: Generate Summary Report
        if: always()
        run: |
          echo "## ðŸŽ¬ Final Video Assembly Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "Video/final_video.mp4" ]; then
            size=$(stat -f%z "Video/final_video.mp4" 2>/dev/null || stat -c%s "Video/final_video.mp4" 2>/dev/null || echo "0")
            size_mb=$(($size/1024/1024))
            
            duration=$(ffprobe -v error -show_entries format=duration -of default=noprint_wrappers=1:nokey=1 "Video/final_video.mp4" 2>/dev/null || echo "0")
            
            echo "### âœ… Success!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ“ File | \`Video/final_video.mp4\` |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ’¾ Size | ${size_mb} MB |" >> $GITHUB_STEP_SUMMARY
            echo "| â±ï¸ Duration | ${duration}s |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸŽ¬ Status | Ready âœ… |" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Final video was not created. Check the logs above for errors." >> $GITHUB_STEP_SUMMARY
          fi
