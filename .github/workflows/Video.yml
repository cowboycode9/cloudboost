name: Final Video Assembly

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'Clips/*.mp4'
      - 'Visuals/visuals.json'
  workflow_run:
    workflows: ["Generate Video Clips"]
    types: [completed]

permissions:
  contents: write

jobs:
  merge-final-video:
    runs-on: ubuntu-latest

    # SAFE conditional (prevents undefined workflow_run errors)
    if: >
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'push' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install FFmpeg
        run: sudo apt-get update && sudo apt-get install -y ffmpeg

      - name: Merge Clips into Final Video (16:9)
        shell: bash
        run: |
          python3 <<'EOF'
          import json
          import os
          import subprocess
          import sys

          VISUALS_PATH = 'Visuals/visuals.json'
          CLIPS_DIR = 'Clips'
          VIDEO_DIR = 'Video'
          NORMALIZED_DIR = 'Clips/normalized'
          CONCAT_FILE = 'clips_to_merge.txt'
          OUTPUT_VIDEO = os.path.join(VIDEO_DIR, 'final_video.mp4')

          # 16:9 aspect ratio settings
          TARGET_WIDTH = 1920
          TARGET_HEIGHT = 1080

          def validate_video(path):
              try:
                  r = subprocess.run(
                      ['ffprobe','-v','error','-select_streams','v:0',
                       '-show_entries','stream=codec_name,width,height:format=duration',
                       '-of','json', path],
                      capture_output=True, text=True, timeout=10
                  )
                  if r.returncode != 0:
                      return False, "ffprobe failed"
                  d = json.loads(r.stdout)
                  if not d.get("streams"):
                      return False, "no video stream"
                  dur = float(d["format"]["duration"])
                  if dur <= 0:
                      return False, "zero duration"
                  s = d["streams"][0]
                  return True, f'{s.get("width")}x{s.get("height")} {dur:.2f}s'
              except Exception as e:
                  return False, str(e)

          def normalize_to_16_9(input_path, output_path):
              """Convert video to 16:9 aspect ratio with padding/scaling"""
              try:
                  # Scale and pad to 16:9, maintaining aspect ratio
                  # This adds black bars if needed
                  filter_complex = (
                      f"scale={TARGET_WIDTH}:{TARGET_HEIGHT}:force_original_aspect_ratio=decrease,"
                      f"pad={TARGET_WIDTH}:{TARGET_HEIGHT}:(ow-iw)/2:(oh-ih)/2:black"
                  )
                  
                  cmd = [
                      'ffmpeg', '-y', '-i', input_path,
                      '-vf', filter_complex,
                      '-c:v', 'libx264',
                      '-preset', 'medium',
                      '-crf', '23',
                      '-c:a', 'aac',
                      '-b:a', '128k',
                      '-r', '30',  # Standard 30fps
                      output_path
                  ]
                  
                  subprocess.run(cmd, capture_output=True, text=True, check=True)
                  return True
              except subprocess.CalledProcessError as e:
                  print(f"âŒ Normalization failed: {e.stderr}")
                  return False

          def main():
              if not os.path.exists(VISUALS_PATH):
                  print("âŒ visuals.json missing")
                  sys.exit(1)

              os.makedirs(VIDEO_DIR, exist_ok=True)
              os.makedirs(NORMALIZED_DIR, exist_ok=True)

              data = json.load(open(VISUALS_PATH))
              valid = []
              normalized_clips = []

              print(f"ðŸŽ¬ Normalizing clips to {TARGET_WIDTH}x{TARGET_HEIGHT} (16:9)...")

              for item in data:
                  n = item.get("number")
                  original_path = os.path.join(CLIPS_DIR, f"c{n}.mp4")
                  normalized_path = os.path.join(NORMALIZED_DIR, f"c{n}_16x9.mp4")
                  
                  if not os.path.exists(original_path):
                      print(f"âŒ Missing {original_path}")
                      continue
                  
                  ok, info = validate_video(original_path)
                  if not ok:
                      print(f"âŒ Invalid {original_path}: {info}")
                      continue
                  
                  print(f"ðŸ“¹ Processing {original_path} ({info})")
                  
                  # Normalize to 16:9
                  if normalize_to_16_9(original_path, normalized_path):
                      ok_norm, info_norm = validate_video(normalized_path)
                      if ok_norm:
                          normalized_clips.append(normalized_path)
                          print(f"âœ… Normalized to {normalized_path} ({info_norm})")
                      else:
                          print(f"âŒ Normalized file invalid: {info_norm}")
                  else:
                      print(f"âŒ Failed to normalize {original_path}")

              if not normalized_clips:
                  print("âŒ No valid normalized clips")
                  sys.exit(1)

              # Create concat file with normalized clips
              with open(CONCAT_FILE, "w") as f:
                  for clip in normalized_clips:
                      f.write(f"file '{clip}'\n")

              print(f"ðŸ”— Concatenating {len(normalized_clips)} clips...")

              # Try concat with copy first
              cmd = [
                  'ffmpeg','-y','-f','concat','-safe','0',
                  '-i',CONCAT_FILE,'-c','copy',
                  '-movflags','+faststart',OUTPUT_VIDEO
              ]

              r = subprocess.run(cmd, capture_output=True, text=True)
              if r.returncode != 0:
                  print("âš ï¸ Copy concat failed, re-encodingâ€¦")
                  inputs = sum([['-i',v] for v in normalized_clips], [])
                  fc = f'concat=n={len(normalized_clips)}:v=1:a=1[outv][outa]'
                  cmd = ['ffmpeg','-y'] + inputs + [
                      '-filter_complex',fc,
                      '-map','[outv]','-map','[outa]',
                      '-c:v','libx264','-preset','medium','-crf','23',
                      '-c:a','aac','-b:a','128k',
                      '-movflags','+faststart',
                      OUTPUT_VIDEO
                  ]
                  subprocess.check_call(cmd)

              # Verify final video
              ok, info = validate_video(OUTPUT_VIDEO)
              if ok:
                  print(f"ðŸŽ‰ Final 16:9 video ready: {info}")
              else:
                  print(f"âŒ Final video validation failed: {info}")
                  sys.exit(1)

          main()
          EOF

      - name: Setup Git LFS if Needed
        run: |
          if [ -f "Video/final_video.mp4" ]; then
            size=$(stat -c%s "Video/final_video.mp4" 2>/dev/null || echo 0)
            if [ "$size" -gt 52428800 ]; then
              git lfs install
              git lfs track "*.mp4"
              git add .gitattributes
            fi
          fi

      - name: Commit and Push
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          git config user.name "intellectra9"
          git config user.email "intellectra9@outlook.com"

          if [ -n "$GH_PAT" ]; then
            git remote set-url origin "https://x-access-token:${GH_PAT}@github.com/${{ github.repository }}.git"
          fi

          git add Video/final_video.mp4 .gitattributes || true

          if git diff --staged --quiet; then
            echo "No changes"
            exit 0
          fi

          git commit -m "ðŸŽ¥ Final 16:9 video assembled ($(date))"

          git pull origin main --rebase || git pull origin main --strategy=ours
          git push origin main

      - name: Summary
        if: always()
        run: |
          echo "## ðŸŽ¬ Final Video Assembly (16:9)" >> $GITHUB_STEP_SUMMARY
          if [ -f "Video/final_video.mp4" ]; then
            echo "âœ… Final 16:9 video created successfully" >> $GITHUB_STEP_SUMMARY
            size=$(stat -c%s "Video/final_video.mp4" 2>/dev/null || echo 0)
            echo "ðŸ“¦ File size: $(($size / 1048576)) MB" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Final video not created" >> $GITHUB_STEP_SUMMARY
          fi
