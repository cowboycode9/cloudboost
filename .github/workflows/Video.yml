name: Final Video Assembly

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'Clips/*.mp4'
      - 'Visuals/visuals.json'
  workflow_run:
    workflows: ["Generate Video Clips"]
    types: [completed]

permissions:
  contents: write

jobs:
  merge-final-video:
    runs-on: ubuntu-latest
    if: >
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'push' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install FFmpeg
        run: sudo apt-get update && sudo apt-get install -y ffmpeg

      - name: Merge Clips into Final Video (16:9)
        shell: bash
        run: |
          python3 <<'EOF'
          import json, os, subprocess, sys

          VISUALS_PATH = 'Visuals/visuals.json'
          CLIPS_DIR = 'Clips'
          VIDEO_DIR = 'Video'
          CONCAT_FILE = 'clips_to_merge.txt'
          OUTPUT_VIDEO = os.path.join(VIDEO_DIR, 'final_video.mp4')

          TARGET_W = 1920
          TARGET_H = 1080

          def get_video_info(path):
              try:
                  r = subprocess.run(
                      ['ffprobe','-v','error','-select_streams','v:0',
                       '-show_entries','stream=width,height:format=duration',
                       '-of','json', path],
                      capture_output=True, text=True
                  )
                  d = json.loads(r.stdout)
                  s = d['streams'][0]
                  return True, s['width'], s['height'], float(d['format']['duration'])
              except:
                  return False, None, None, None

          os.makedirs(VIDEO_DIR, exist_ok=True)

          if not os.path.exists(VISUALS_PATH):
              sys.exit(1)

          data = json.load(open(VISUALS_PATH))
          clips = []

          for item in data:
              n = item.get("number")
              p = os.path.join(CLIPS_DIR, f"c{n}.mp4")
              ok, w, h, d = get_video_info(p) if os.path.exists(p) else (False,None,None,None)
              if not ok:
                  continue
              clips.append(p)

          if not clips:
              sys.exit(1)

          all_16_9 = True
          for c in clips:
              ok, w, h, _ = get_video_info(c)
              if not ok or abs((w / h) - (16 / 9)) > 0.01:
                  all_16_9 = False
                  break

          if all_16_9:
              with open(CONCAT_FILE, "w") as f:
                  for c in clips:
                      f.write(f"file '{c}'\n")

              r = subprocess.run([
                  'ffmpeg','-y','-f','concat','-safe','0',
                  '-i',CONCAT_FILE,'-c','copy',
                  '-movflags','+faststart',OUTPUT_VIDEO
              ])

              if r.returncode == 0:
                  sys.exit(0)

          inputs = sum([['-i',c] for c in clips], [])

          filter_complex = (
              f"concat=n={len(clips)}:v=1:a=1[v];"
              f"[v]scale={TARGET_W}:{TARGET_H}:force_original_aspect_ratio=decrease,"
              f"pad={TARGET_W}:{TARGET_H}:(ow-iw)/2:(oh-ih)/2,"
              f"setsar=1[vout]"
          )

          cmd = (
              ['ffmpeg','-y'] +
              inputs +
              ['-filter_complex', filter_complex,
               '-map','[vout]',
               '-map','0:a?',
               '-c:v','libx264',
               '-profile:v','high',
               '-level','4.2',
               '-pix_fmt','yuv420p',
               '-preset','medium',
               '-crf','23',
               '-c:a','aac',
               '-b:a','192k',
               '-movflags','+faststart',
               OUTPUT_VIDEO]
          )

          subprocess.check_call(cmd)
          EOF

      - name: Setup Git LFS if Needed
        run: |
          if [ -f "Video/final_video.mp4" ]; then
            size=$(stat -c%s "Video/final_video.mp4" 2>/dev/null || echo 0)
            if [ "$size" -gt 52428800 ]; then
              git lfs install
              git lfs track "*.mp4"
              git add .gitattributes
            fi
          fi

      - name: Commit and Push
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          git config user.name "intellectra9"
          git config user.email "intellectra9@outlook.com"

          if [ -n "$GH_PAT" ]; then
            git remote set-url origin "https://x-access-token:${GH_PAT}@github.com/${{ github.repository }}.git"
          fi

          git add Video/final_video.mp4 .gitattributes || true

          if git diff --staged --quiet; then
            exit 0
          fi

          git commit -m "ðŸŽ¥ Final video assembled ($(date))"
          git pull origin main --rebase || git pull origin main --strategy=ours
          git push origin main

      - name: Summary
        if: always()
        run: |
          echo "## ðŸŽ¬ Final Video Assembly" >> $GITHUB_STEP_SUMMARY
          if [ -f "Video/final_video.mp4" ]; then
            echo "âœ… Final video created" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Final video failed" >> $GITHUB_STEP_SUMMARY
          fi
