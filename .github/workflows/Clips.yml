name: Generate Video Clips

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Generate Sentence Voiceovers"]
    types:
      - completed

permissions:
  contents: write

jobs:
  create-clips:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install FFmpeg
        run: sudo apt-get update && sudo apt-get install -y ffmpeg

      - name: Generate High Quality MP4 Clips
        shell: bash
        run: |
          python3 <<'EOF'
          import json
          import os
          import subprocess
          import sys

          VISUALS_PATH = 'Visuals/visuals.json'
          AUDIO_DIR = 'Audio'
          IMAGE_DIR = 'Images'
          CLIPS_DIR = 'Clips'

          os.makedirs(CLIPS_DIR, exist_ok=True)

          def validate_media(path, type_):
              if not os.path.exists(path):
                  return False
              if os.path.getsize(path) < 1000:
                  return False
              return True

          def validate_output(path):
              try:
                  r = subprocess.run(
                      ['ffprobe','-v','error','-show_entries',
                       'format=duration','-of',
                       'default=noprint_wrappers=1:nokey=1', path],
                      capture_output=True,text=True,timeout=10
                  )
                  if r.returncode != 0:
                      return False
                  dur = float(r.stdout.strip())
                  return dur > 0
              except:
                  return False

          def create_clip(num):
              audio = os.path.join(AUDIO_DIR, f"a{num}.mp3")
              image = os.path.join(IMAGE_DIR, f"i{num}.png")
              output = os.path.join(CLIPS_DIR, f"c{num}.mp4")

              print(f"\n--- Processing clip {num} ---")

              if not validate_media(audio,"audio"):
                  print("âŒ Invalid audio")
                  return False

              if not validate_media(image,"image"):
                  print("âŒ Invalid image")
                  return False

              cmd = [
                  'ffmpeg','-y',
                  '-loop','1',
                  '-i',image,
                  '-i',audio,
                  '-vf','scale=1920:1080:force_original_aspect_ratio=decrease,pad=1920:1080:(ow-iw)/2:(oh-ih)/2',
                  '-c:v','libx264',
                  '-preset','slow',
                  '-crf','20',
                  '-profile:v','high',
                  '-level','4.2',
                  '-pix_fmt','yuv420p',
                  '-c:a','aac',
                  '-b:a','192k',
                  '-ar','44100',
                  '-movflags','+faststart',
                  '-shortest',
                  output
              ]

              try:
                  subprocess.run(cmd,check=True)
              except subprocess.CalledProcessError:
                  print("âŒ FFmpeg failed")
                  return False

              if not validate_output(output):
                  print("âŒ Output corrupted")
                  if os.path.exists(output):
                      os.remove(output)
                  return False

              size = os.path.getsize(output)
              print(f"âœ… Created {output} ({size//1024} KB)")
              return True

          def main():
              if not os.path.exists(VISUALS_PATH):
                  print("âŒ visuals.json missing")
                  sys.exit(1)

              data = json.load(open(VISUALS_PATH))
              success = 0

              for item in data:
                  num = item.get("number")
                  if num and create_clip(num):
                      success += 1

              print(f"\nðŸŽ¬ Successfully created {success} clips")

              if success == 0:
                  sys.exit(1)

          main()
          EOF

      - name: Commit and Push Clips
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          git config --global user.name "intellectra9"
          git config --global user.email "intellectra9@outlook.com"
          git config --global --add safe.directory "$GITHUB_WORKSPACE"

          if [ -n "$GH_PAT" ]; then
            git remote set-url origin "https://x-access-token:${GH_PAT}@github.com/${{ github.repository }}.git"
          fi

          git add Clips/*.mp4 2>/dev/null || echo "No MP4 files"

          if git diff --staged --quiet; then
            echo "No new clips"
            exit 0
          fi

          timestamp=$(TZ="Asia/Kolkata" date +"%Y-%m-%d %H:%M:%S IST")
          clip_count=$(git diff --staged --name-only | grep -c "\.mp4$" || echo "0")

          git commit -m "ðŸŽ¬ Generated ${clip_count} high-quality clips: ${timestamp}"

          git pull origin main --rebase || git pull origin main --strategy-option=ours
          git push origin main
