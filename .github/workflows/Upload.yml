name: Sync Google Drive Images (Unlimited Files)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"   # Runs every 6 hours (optional)

permissions:
  contents: write

jobs:
  sync-images:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          lfs: false

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install Dependencies
        run: pip install requests gdown

      - name: Clean Old Images
        run: |
          mkdir -p Images
          rm -rf Images/*

      - name: Download Images from Google Drive (Unlimited Files)
        run: |
          python3 - <<EOF
          import os
          import re
          import requests
          import gdown

          FOLDER_ID = "1Eq5Qx94znqKnr9cIrPAgd5kW7iwISxVx"
          OUTPUT_DIR = "Images"

          os.makedirs(OUTPUT_DIR, exist_ok=True)

          print("Fetching folder page...")

          url = f"https://drive.google.com/drive/folders/{FOLDER_ID}"
          response = requests.get(url)
          html = response.text

          # Extract file IDs and names
          matches = re.findall(r'"id":"([a-zA-Z0-9_-]{28,})".*?"name":"([^"]+)"', html)

          if not matches:
              print("No files found. Make sure folder is public.")
              exit(1)

          print(f"Total files found: {len(matches)}")

          for file_id, filename in matches:
              output_path = os.path.join(OUTPUT_DIR, filename)
              download_url = f"https://drive.google.com/uc?id={file_id}"
              print(f"Downloading {filename}...")
              try:
                  gdown.download(download_url, output_path, quiet=False)
              except Exception as e:
                  print(f"Failed: {filename} -> {e}")

          print("All images downloaded successfully.")
          EOF

      - name: Commit and Push Images
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          git config --global user.name "cowboycode9"
          git config --global user.email "cowboycode9@outlook.com"

          if [ -n "$GH_PAT" ]; then
            git remote set-url origin "https://x-access-token:${GH_PAT}@github.com/${{ github.repository }}.git"
          fi

          git add Images/

          if git diff --staged --quiet; then
            echo "No image changes detected."
          else
            timestamp=$(TZ="Asia/Kolkata" date +"%Y-%m-%d %H:%M:%S IST")
            git commit -m "üñºÔ∏è Drive Image Sync: ${timestamp}"
            git pull origin main --rebase
            git push origin main
          fi
