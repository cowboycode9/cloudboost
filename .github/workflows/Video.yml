name: Final Video Assembly

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Generate Video Clips"]
    types:
      - completed

permissions:
  contents: write

jobs:
  merge-final-video:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install FFmpeg
        run: sudo apt-get update && sudo apt-get install -y ffmpeg

      - name: Merge Clips into Final Video
        shell: bash
        run: |
          python3 - <<EOF
          import json
          import os
          import subprocess

          # --- CONFIGURATION ---
          VISUALS_PATH = 'Visuals/visuals.json'
          CLIPS_DIR = 'Clips'
          VIDEO_DIR = 'Video'
          CONCAT_FILE = 'clips_to_merge.txt'
          OUTPUT_VIDEO = os.path.join(VIDEO_DIR, 'final_video.mp4')

          def main():
              if not os.path.exists(VISUALS_PATH):
                  print("Visuals file not found.")
                  return
              
              os.makedirs(VIDEO_DIR, exist_ok=True)

              with open(VISUALS_PATH, 'r') as f:
                  data = json.load(f)

              # Create the list of clips in the correct order based on visuals.json
              clips = []
              for item in data:
                  num = item.get('number')
                  clip_path = os.path.join(CLIPS_DIR, f"c{num}.mp4")
                  if os.path.exists(clip_path):
                      # FFmpeg concat demuxer requires 'file' prefix
                      clips.append(f"file '{clip_path}'")
                  else:
                      print(f"Warning: Clip {clip_path} missing, skipping.")

              if not clips:
                  print("No clips found to merge.")
                  return

              # Write the concat list to a temporary text file
              with open(CONCAT_FILE, 'w') as f:
                  f.write('\n'.join(clips))

              # Run FFmpeg Concat
              # -f concat: Use concat demuxer
              # -safe 0: Allow absolute/relative paths
              # -c copy: Stream copy (fastest, no re-encoding)
              cmd = [
                  'ffmpeg', '-y',
                  '-f', 'concat',
                  '-safe', '0',
                  '-i', CONCAT_FILE,
                  '-c', 'copy',
                  OUTPUT_VIDEO
              ]
              
              subprocess.run(cmd, check=True)
              print(f"Final Video Created: {OUTPUT_VIDEO}")
              
              # Cleanup temp file
              if os.path.exists(CONCAT_FILE):
                  os.remove(CONCAT_FILE)

          if __name__ == "__main__":
              main()
          EOF

      - name: Commit and Push Final Video
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          git config --global user.name "cowboycode9"
          git config --global user.email "cowboycode9@outlook.com"
          
          if [ -n "$GH_PAT" ]; then
            git remote set-url origin "https://x-access-token:${GH_PAT}@github.com/${{ github.repository }}.git"
          fi

          git add Video/final_video.mp4
          
          if git diff --staged --quiet; then
            echo "No changes in final video."
          else
            timestamp=$(TZ="Asia/Kolkata" date +"%Y-%m-%d %H:%M:%S IST")
            git commit -m "ðŸš€ Final Video Rendered: ${timestamp}"
            git pull origin main --rebase
            git push origin main
          fi
