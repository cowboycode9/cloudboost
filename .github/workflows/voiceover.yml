name: Generate Sentence Voiceovers

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'Visuals/visuals.json'

permissions:
  contents: write

jobs:
  voiceover-generation:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: pip install edge-tts nest_asyncio

      - name: Generate Audio Files
        shell: bash
        run: |
          python3 - <<EOF
          import json
          import asyncio
          import edge_tts
          import os
          import nest_asyncio

          # --- CONFIGURATION ---
          VISUALS_PATH = 'Visuals/visuals.json'
          AUDIO_FOLDER = 'Audio'
          VOICE = "en-US-AndrewNeural"

          nest_asyncio.apply()

          async def generate_audio(text, output_path):
              communicate = edge_tts.Communicate(text, VOICE)
              await communicate.save(output_path)
              print(f"Generated: {output_path}")

          async def main():
              if not os.path.exists(VISUALS_PATH):
                  print(f"Error: {VISUALS_PATH} not found")
                  return

              os.makedirs(AUDIO_FOLDER, exist_ok=True)

              with open(VISUALS_PATH, 'r') as f:
                  data = json.load(f)

              tasks = []
              for item in data:
                  # Assumes json has 'number' (1, 2, 3...) and 'sentence' fields
                  num = item.get('number')
                  text = item.get('sentence')
                  
                  if text and num:
                      output_file = os.path.join(AUDIO_FOLDER, f"a{num}.mp3")
                      tasks.append(generate_audio(text, output_file))

              # Run all generations concurrently for speed
              await asyncio.gather(*tasks)

          if __name__ == "__main__":
              asyncio.run(main())
          EOF

      - name: Commit and Push Audio
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          git config --global user.name "cowboycode9"
          git config --global user.email "cowboycode9@outlook.com"
          
          # Use GH_PAT for authentication if provided, otherwise default token
          if [ -n "$GH_PAT" ]; then
            git remote set-url origin "https://x-access-token:${GH_PAT}@github.com/${{ github.repository }}.git"
          fi

          git add Audio/*.mp3
          
          if git diff --staged --quiet; then
            echo "No new audio files to commit."
          else
            timestamp=$(TZ="Asia/Kolkata" date +"%Y-%m-%d %H:%M:%S IST")
            git commit -m "ðŸŽ™ï¸ Batch Voiceover Update: ${timestamp}"
            git pull origin main --rebase
            git push origin main
          fi
