name: Generate Video Clips

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Generate Sentence Voiceovers"]
    types:
      - completed

permissions:
  contents: write

jobs:
  create-clips:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install FFmpeg
        run: sudo apt-get update && sudo apt-get install -y ffmpeg

      - name: Generate MP4 Clips
        shell: bash
        run: |
          python3 - <<'EOF'
          # (YOUR ENTIRE PYTHON CODE BLOCK REMAINS EXACTLY THE SAME HERE)
          EOF

      - name: Commit and Push Clips
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          git config --global user.name "intellectra9"
          git config --global user.email "intellectra9@outlook.com"
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          
          if [ -n "$GH_PAT" ]; then
            git remote set-url origin "https://x-access-token:${GH_PAT}@github.com/${{ github.repository }}.git"
          fi

          # Add all clips
          git add Clips/*.mp4 2>/dev/null || echo "No MP4 files to add"
          
          if git diff --staged --quiet; then
            echo "No new clips to commit."
          else
            timestamp=$(TZ="Asia/Kolkata" date +"%Y-%m-%d %H:%M:%S IST")
            
            clip_count=$(git diff --staged --name-only | grep -c "\.mp4$" || echo "0")
            
            git commit -m "üé¨ Generated ${clip_count} video clips: ${timestamp}"
            
            git pull origin main --rebase || git pull origin main --strategy-option=ours
            
            max_retries=3
            retry_count=0
            
            while [ $retry_count -lt $max_retries ]; do
              if git push origin main; then
                echo "‚úÖ Successfully pushed clips!"
                exit 0
              else
                retry_count=$((retry_count + 1))
                echo "‚ö†Ô∏è Push failed, retrying ($retry_count/$max_retries)..."
                sleep 5
                git pull origin main --rebase || git pull origin main --strategy-option=ours
              fi
            done
            
            echo "‚ùå Failed to push after $max_retries attempts"
            exit 1
          fi
