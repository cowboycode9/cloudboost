name: Transcript

on:
  workflow_run:
    workflows: ["Voiceover"] 
    types:
      - completed
  workflow_dispatch: 

jobs:
  transcribe:
    runs-on: ubuntu-latest
    
    # Only run if the triggering workflow succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name != 'workflow_run' }}
    
    permissions:
      contents: write
      actions: read
      
    steps:
      # --- CRITICAL: FREE UP DISK SPACE ---
      # Prevents "No space left on device" error
      - name: Free Disk Space (Ubuntu)
        run: |
          echo "Freeing up disk space..."
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          echo "Disk space freed."

      # 1) Checkout your repo
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      # 2) Pull latest changes
      - name: Pull latest changes
        run: |
          git config --local user.name "intellectra9"
          git config --local user.email "intellectra9@outlook.com"
          git pull origin main --rebase || git pull origin main

      # 3) Install ffmpeg
      - name: Install ffmpeg
        run: sudo apt-get update && sudo apt-get install -y ffmpeg

      # 4) Set up Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # 5) Install dependencies (FORCE DOWNGRADE METHOD)
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip --no-cache-dir
          
          # 1. Install WhisperX and its dependencies first (This might install Torch 2.6)
          pip install git+https://github.com/openai/whisper.git --no-cache-dir
          pip install git+https://github.com/m-bain/whisperx.git --no-cache-dir
          
          # 2. FORCE REINSTALL Torch to 2.5.1
          # We use --force-reinstall to overwrite whatever version WhisperX installed.
          # We use --index-url .../cpu to keep the download small.
          pip install "torch==2.5.1" "torchaudio==2.5.1" --index-url https://download.pytorch.org/whl/cpu --force-reinstall --no-cache-dir

      # 6) Debug: Verify Torch Version
      - name: Check Torch Version
        run: |
          python -c "import torch; print(f'INSTALLED TORCH VERSION: {torch.__version__}')"

      # 7) Run WhisperX transcription
      - name: Transcribe entire audio with WhisperX word-level timestamps
        run: |
          python -c "
          import whisperx
          import os
          import json
          import torch
          
          print(f'Runtime Torch Version: {torch.__version__}')
          
          # Force CPU usage
          device = 'cpu'
          compute_type = 'float32'
          batch_size = 16
          
          audio_file = 'Audio/a1.mp3'

          print('Loading WhisperX model...')
          # We explicitly set download_root to current dir to avoid permission issues in some envs
          model = whisperx.load_model('base', device, compute_type=compute_type, language='en')

          print('Loading audio...')
          audio = whisperx.load_audio(audio_file, sr=16000)

          print('Transcribing audio...')
          result = model.transcribe(audio, batch_size=batch_size)
          print('Initial transcription completed')

          print('Loading alignment model...')
          model_a, metadata = whisperx.load_align_model(language_code=result['language'], device=device)

          print('Aligning for word-level timestamps...')
          result = whisperx.align(result['segments'], model_a, metadata, audio, device, return_char_alignments=False)
          print('Word-level alignment completed')

          # Create Trans folder
          os.makedirs('Trans', exist_ok=True)
          
          # Remove existing files
          files_to_replace = ['Trans/t1.txt', 'Trans/timestamps.txt', 'Trans/transcription.json']
          for file_path in files_to_replace:
              if os.path.exists(file_path):
                  os.remove(file_path)
                  print(f'Removed existing file: {file_path}')

          # Write detailed results
          with open('Trans/t1.txt', 'w', encoding='utf-8') as f:
              f.write('WhisperX FULL Word-Level Transcription Results\\n')
              f.write('=' * 60 + '\\n\\n')
              
              for i, segment in enumerate(result['segments']):
                  segment_text = segment.get('text', '').strip()
                  segment_start = segment.get('start', 0)
                  segment_end = segment.get('end', 0)
                  
                  f.write(f'SEGMENT {i+1}: [{segment_start:.2f}s - {segment_end:.2f}s]\\n')
                  f.write(f'Text: \"{segment_text}\"\\n')
                  
                  if 'words' in segment and segment['words']:
                      f.write('Word-level timestamps:\\n')
                      for j, word in enumerate(segment['words']):
                          word_text = word.get('word', '').strip()
                          word_start = word.get('start', 0)
                          word_end = word.get('end', 0)
                          f.write(f'  {j+1:2d}. \"{word_text}\" -> {word_start:.2f}s - {word_end:.2f}s\\n')
                  f.write('\\n' + '-' * 50 + '\\n\\n')

          # Write CSV timestamps
          with open('Trans/timestamps.txt', 'w', encoding='utf-8') as f:
              for segment in result['segments']:
                  if 'words' in segment and segment['words']:
                      for word in segment['words']:
                          word_text = word.get('word', '').strip()
                          word_start = word.get('start', 0)
                          word_end = word.get('end', 0)
                          f.write(f'{word_text},{word_start:.2f},{word_end:.2f}\\n')

          # Write JSON output
          with open('Trans/transcription.json', 'w', encoding='utf-8') as f:
              json.dump(result, f, indent=2, ensure_ascii=False)

          print('âœ… WhisperX transcription completed for FULL audio!')
          "

      # 8) Commit and push
      - name: Commit and push transcription files
        run: |
          git add Trans/
          
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            echo "Committing updated transcription files..."
            timestamp=$(TZ="Asia/Kolkata" date +"%Y-%m-%d %H:%M:%S IST")
            
            git commit -m "ðŸ”„ Update WhisperX word-level transcription: ${timestamp}"
            
            echo "Pulling latest changes..."
            git pull origin main --rebase || { 
               git pull origin main --strategy-option=ours 
            }
            
            echo "Pushing changes..."
            git push origin main
            echo "âœ… Done!"
          fi
