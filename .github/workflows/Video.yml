name: Final Video Assembly

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'Clips/*.mp4'
      - 'Visuals/visuals.json'
  workflow_run:
    workflows: ["Generate Video Clips"]
    types: [completed]

permissions:
  contents: write

jobs:
  merge-final-video:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install FFmpeg
        run: sudo apt-get update && sudo apt-get install -y ffmpeg

      - name: Merge Clips into Final Video
        shell: bash
        run: |
          python3 <<'EOF'
          import json
          import os
          import subprocess
          import sys

          VISUALS_PATH = 'Visuals/visuals.json'
          CLIPS_DIR = os.path.abspath('Clips')
          VIDEO_DIR = 'Video'
          CONCAT_FILE = 'clips.txt'
          OUTPUT_VIDEO = os.path.join(VIDEO_DIR, 'final_video.mp4')

          if not os.path.exists(VISUALS_PATH):
              sys.exit(1)

          os.makedirs(VIDEO_DIR, exist_ok=True)

          data = json.load(open(VISUALS_PATH))
          valid = []

          for item in data:
              n = item.get("number")
              clip = os.path.join(CLIPS_DIR, f"c{n}.mp4")

              if os.path.exists(clip) and os.path.getsize(clip) > 50000:
                  valid.append(clip)
                  print(f"‚úÖ {clip}")
              else:
                  print(f"‚ùå Invalid {clip}")

          if not valid:
              sys.exit(1)

          with open(CONCAT_FILE, "w") as f:
              for v in valid:
                  f.write(f"file '{v}'\n")

          cmd = [
              'ffmpeg','-y',
              '-f','concat',
              '-safe','0',
              '-i',CONCAT_FILE,
              '-c','copy',
              OUTPUT_VIDEO
          ]

          result = subprocess.run(cmd)

          if result.returncode != 0:
              inputs = []
              for v in valid:
                  inputs += ['-i', v]

              filter_complex = f'concat=n={len(valid)}:v=1:a=1[outv][outa]'

              cmd = ['ffmpeg','-y'] + inputs + [
                  '-filter_complex', filter_complex,
                  '-map','[outv]',
                  '-map','[outa]',
                  '-c:v','libx264',
                  '-crf','20',
                  '-preset','medium',
                  '-c:a','aac',
                  OUTPUT_VIDEO
              ]

              subprocess.check_call(cmd)

          print("üéâ Final video created")
          EOF

      - name: Commit and Push Final Video
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          git config --global user.name "cowboycode9"
          git config --global user.email "cowboycode9@outlook.com"

          if [ -n "$GH_PAT" ]; then
            git remote set-url origin "https://x-access-token:${GH_PAT}@github.com/${{ github.repository }}.git"
          fi

          git add Video/final_video.mp4 || true

          if git diff --staged --quiet; then
            echo "No new final video."
          else
            timestamp=$(TZ="Asia/Kolkata" date +"%Y-%m-%d %H:%M:%S IST")
            git commit -m "üé• Final Video Update: ${timestamp}"
            git push origin main
          fi
